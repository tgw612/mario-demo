<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mall.discover.persistence.dao.mysql.ClientSubjectMapper">
    <select id="querySubjectPage" resultType="com.mall.discover.persistence.bo.SubjectBO">
        SELECT
        ds.subject_id, ds.subject_name, ds.subject_content, ds.subject_look, ds.create_time,
        dc.sort, dc.read_count, dc.share_count
        FROM
        discover_subject AS ds
        INNER JOIN discover_count AS dc ON ds.subject_id = dc.bizId
        <where>
            ds.is_deleted = 0
            AND dc.is_deleted = 0
            AND dc.biztype = #{param.bizType}
            AND ds.subject_status = 2
        </where>
        order by dc.sort ASC, ds.create_time DESC
        LIMIT #{startRecord},#{recordSize}
    </select>

    <select id="querySubjectPageCount" resultType="java.lang.Integer">
        SELECT
        count(ds.subject_id)
        FROM
        discover_subject AS ds
        INNER JOIN discover_count AS dc ON ds.subject_id = dc.bizId
        <where>
            ds.is_deleted = 0
            AND dc.is_deleted = 0
            AND dc.biztype = #{param.bizType}
            AND ds.subject_status = 2
        </where>
    </select>

    <select id="queryArticleCount" resultType="com.mall.discover.persistence.bo.SubjectBO">
        SELECT
        from_id as subjectId,
        count(da.article_id) AS articleCount
        FROM
        discover_relation AS dr
        INNER JOIN discover_article AS da ON da.article_id = dr.to_id
        WHERE
            dr.is_deleted = 0
        AND da.is_deleted = 0
        AND da.article_status = 2
        AND dr.biztype = #{param.relation}
        AND dr.from_id IN
        <foreach collection="list" item="item" close=")" open="(" separator=",">
            #{item}
        </foreach>
        group by dr.from_id
    </select>

    <select id="querySubjectInfo" resultType="com.mall.discover.persistence.bo.SubjectBO">
        SELECT
        ds.subject_id, ds.subject_name, ds.subject_content, ds.subject_look,ds.create_time,
        dc.sort, dc.read_count,dc.share_count
        FROM
        discover_subject AS ds
        INNER JOIN discover_count AS dc ON ds.subject_id = dc.bizId
        <where>
            ds.is_deleted = 0
            AND dc.is_deleted = 0
            AND dc.biztype = #{param.bizType}
            AND subject_id = #{param.subjectId}
        </where>
        LIMIT 1
    </select>

    <select id="querySubjectArticlePage" resultType="com.mall.discover.persistence.bo.SubjectArticleBO">
    SELECT
        da.article_id,
        da.article_title,
        da.article_content,
        da.article_status,
        da.create_time,
        da.article_look,
        dc.read_count,
        dc.share_count,
        dc.sort
    FROM
        discover_relation AS dr
        INNER JOIN discover_article AS da ON da.article_id = dr.to_id
        INNER JOIN discover_count AS dc ON dc.bizId = da.article_id
    WHERE
        dr.is_deleted = 0
        AND da.is_deleted = 0
        AND dc.is_deleted = 0
        AND da.article_status = 2
        AND dr.biztype = #{param.relation}
        AND dc.biztype = 1
        AND dr.from_id = #{param.subjectId}
    order by dr.sort ASC,dc.sort_client desc
    LIMIT #{startRecord},#{recordSize}
  </select>

    <select id="querySubjectArticlePageCount" resultType="java.lang.Integer">
    SELECT
        count(da.article_id)
    FROM
        discover_relation AS dr
        INNER JOIN discover_article AS da ON da.article_id = dr.to_id
        INNER JOIN discover_count AS dc ON dc.bizId = da.article_id
    WHERE
        dr.is_deleted = 0
        AND da.is_deleted = 0
        AND dc.is_deleted = 0
        AND da.article_status = 2
        AND dr.biztype = #{param.relation}
        AND dc.biztype = 1
        AND dr.from_id = #{param.subjectId}
   group by dr.from_id
  </select>

    <select id="queryAllSubjectId" resultType="java.lang.Long">
        SELECT
        subject_id
        FROM
        discover_subject
        <where>
            is_deleted = 0
            AND subject_status = 2
        </where>
    </select>
</mapper>